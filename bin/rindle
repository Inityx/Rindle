#!/usr/bin/env ruby

require './lib/fetcher'
require './lib/compiler'

require 'time'

D_SUB = 'talesfromtechsupport'.freeze
D_TYPE = :hot
D_COUNT = 100
NOWSTRING = Time.now.strftime('%Y-%m-%d-%H%M').freeze

ID = [D_SUB, D_TYPE, NOWSTRING].freeze
DEST_DIR = "./#{ID.join('_')}".freeze
TITLE = ID.join(' ').freeze

STYLESHEET = './static/stylesheet.css'.freeze

raise "#{DEST_DIR} is not empty" if Dir.exist?(DEST_DIR) && (Dir.entries(DEST_DIR) - %w(. ..)).any?

puts 'Locating kindlegen...'
kindlegen_found = system('which kindlegen')
abort unless kindlegen_found
puts

puts 'Fetching posts...'
posts = Rindle::Fetcher.new(
  D_SUB,
  D_TYPE
).fetch(
  D_COUNT
)
puts

puts 'Compiling to eBook source...'
metadata_file = Rindle::Compiler.new(
  DEST_DIR,
  STYLESHEET
).compile(
  TITLE,
  posts
)
puts

puts 'Invoking kindlegen...'
system("kindlegen #{metadata_file}")
